name: Update Preview DB

on:
  workflow_dispatch:

jobs:
  update-preview-db:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout code
      - uses: actions/checkout@v3

      # 2ï¸âƒ£ Installer Supabase CLI
      - name: Install Supabase CLI
        run: |
          curl -fsSL https://cdn.jsdelivr.net/npm/supabase-cli@1.84.0/install.sh | bash
          echo "$HOME/.supabase/bin" >> $GITHUB_PATH

      # 3ï¸âƒ£ Reset, push et seed DB en un seul step
      - name: Reset, Push and Seed Preview DB
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF_PREVIEW }}
        run: |
          echo "ğŸ”— Linking preview DB"
          npx supabase link --project-ref $SUPABASE_PROJECT_REF
          echo "âœ… Linked preview DB"
          echo "ğŸš® Resetting preview DB,"
          echo "â¬†ï¸ Pushing migrations,"
          echo "ğŸŒ± Seeding preview DB..."
          npx supabase db reset --linked --yes
          echo "âœ… Preview DB updated successfully!"
